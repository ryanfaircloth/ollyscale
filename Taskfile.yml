version: "3"

# OllyScale Build System
# Unified build configuration for local (Podman) and CI (Docker buildx)
# Install taskfile: https://taskfile.dev/installation/

vars:
  # Project configuration (from environment in CI, hardcoded for local)
  PROJECT_SLUG:
    sh: echo "${PROJECT_SLUG:-ollyscale}"
  GH_ORG:
    sh: echo "${GH_ORG:-ryanfaircloth}"

  # Container runtime detection
  CONTAINER_RUNTIME:
    sh: |
      if command -v podman &> /dev/null; then
        echo "podman"
      elif command -v docker &> /dev/null; then
        echo "docker"
      else
        echo "none"
      fi

  # Registry configuration
  REGISTRY: ghcr.io
  REGISTRY_ORG: "{{.GH_ORG}}"
  IMAGE_PREFIX: "{{.REGISTRY}}/{{.REGISTRY_ORG}}/{{.PROJECT_SLUG}}"

  # Local development registry (KIND cluster)
  EXTERNAL_REGISTRY: registry.ollyscale.test:49443
  INTERNAL_REGISTRY: docker-registry.registry.svc.cluster.local:5000
  EXTERNAL_CHART_REGISTRY: "{{.EXTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/charts"
  INTERNAL_CHART_REGISTRY: "{{.INTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/charts"

  # Build configuration
  VERSION:
    sh: echo "${VERSION:-0.0.0-dev.$(date +%s)}"

  # Kubernetes
  CLUSTER_NAME: "{{.PROJECT_SLUG}}"
  NAMESPACE: ollyscale

  # Container-specific flags
  PODMAN_FLAGS: --tls-verify=false
  DOCKER_FLAGS: ""

  PUSH_FLAGS:
    sh: |
      if [ "{{.CONTAINER_RUNTIME}}" = "podman" ]; then
        echo "--tls-verify=false"
      else
        echo ""
      fi

  # Build platform (local vs CI)
  BUILD_PLATFORMS:
    sh: |
      if [ "${CI:-false}" = "true" ]; then
        echo "linux/amd64,linux/arm64"
      else
        echo "$(uname -m | sed 's/x86_64/linux\/amd64/;s/aarch64/linux\/arm64/;s/arm64/linux\/arm64/')"
      fi

env:
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain

set:
  - errexit
  - pipefail
  - nounset

tasks:
  # ====================
  # Setup & Validation
  # ====================

  check:
    desc: Check prerequisites and configuration
    cmds:
      - echo "Checking build environment..."
      - |
        # Check for required commands
        MISSING=""

        if ! command -v uv &> /dev/null; then
          echo "âŒ uv not found (required for Python dependency management)"
          MISSING="$MISSING uv"
        fi

        if [ "{{.CONTAINER_RUNTIME}}" = "none" ]; then
          echo "âŒ Neither podman nor docker found (required for container builds)"
          MISSING="$MISSING podman/docker"
        fi

        if ! command -v helm &> /dev/null; then
          echo "âŒ helm not found (required for chart packaging)"
          MISSING="$MISSING helm"
        fi

        if ! command -v yq &> /dev/null; then
          echo "âŒ yq not found (required for YAML manipulation)"
          MISSING="$MISSING yq"
        fi

        if ! command -v kubectl &> /dev/null; then
          echo "âŒ kubectl not found (required for Kubernetes operations)"
          MISSING="$MISSING kubectl"
        fi

        if ! command -v kind &> /dev/null; then
          echo "âŒ kind not found (required for local cluster)"
          MISSING="$MISSING kind"
        fi

        if ! command -v terraform &> /dev/null; then
          echo "âŒ terraform not found (required for infrastructure)"
          MISSING="$MISSING terraform"
        fi

        if [ -n "$MISSING" ]; then
          echo ""
          echo "Missing required commands:$MISSING"
          echo ""
          echo "Install missing tools:"
          echo "  uv: curl -LsSf https://astral.sh/uv/install.sh | sh"
          echo "  podman: brew install podman"
          echo "  helm: brew install helm"
          echo "  yq: brew install yq"
          echo "  kubectl: brew install kubectl"
          echo "  kind: brew install kind"
          echo "  terraform: brew install terraform"
          exit 1
        fi
      - echo "âœ“ All required commands available"
      - 'echo "Container runtime: {{.CONTAINER_RUNTIME}}"'
      - 'echo "Build version: {{.VERSION}}"'
      - 'echo "Build platforms: {{.BUILD_PLATFORMS}}"'
      - 'echo "Registry: {{.EXTERNAL_REGISTRY}}"'
      - echo "âœ… Environment ready"

  install:
    desc: Install dependencies for all Python projects
    deps:
      - install:api
      - install:demo
      - install:demo-agent
      - install:build

  install:api:
    desc: Install API dependencies
    dir: apps/api
    cmds:
      - echo "ğŸ“¦ Installing API dependencies..."
      - uv sync --all-extras

  install:demo:
    desc: Install demo dependencies
    dir: apps/demo
    cmds:
      - echo "ğŸ“¦ Installing demo dependencies..."
      - uv sync --all-extras

  install:demo-agent:
    desc: Install demo-agent dependencies
    dir: apps/demo-otel-agent
    cmds:
      - echo "ğŸ“¦ Installing demo-agent dependencies..."
      - uv sync --all-extras

  install:build:
    desc: Install build script dependencies
    dir: scripts/build
    cmds:
      - echo "ğŸ“¦ Installing build dependencies..."
      - uv sync

  # ====================
  # Testing & Quality
  # ====================

  lint:
    desc: Run pre-commit checks (required before build)
    cmds:
      - echo "Running pre-commit checks..."
      - pre-commit run --all-files
      - echo "Lint checks passed"

  lint-fix:
    desc: Run pre-commit with auto-fix
    cmds:
      - echo "ğŸ”§ Running pre-commit with auto-fix..."
      - pre-commit run --all-files || true
      - echo "ğŸ”§ Auto-fixes applied. Review changes before committing."

  precommit-setup:
    desc: Install and configure pre-commit hooks
    cmds:
      - echo "ğŸ”§ Setting up pre-commit hooks for ollyScale..."
      - |
        if ! command -v pre-commit &> /dev/null; then
          echo "ğŸ“¦ Installing pre-commit..."
          pip install pre-commit
        else
          echo "âœ… pre-commit is already installed"
        fi
      - echo "ğŸ”— Installing git hooks..."
      - pre-commit install
      - echo "ğŸ“ Installing commit-msg hook..."
      - pre-commit install --hook-type commit-msg || echo "âš ï¸  commit-msg hook not configured (optional)"
      - echo "ğŸ§ª Running pre-commit on all files (this may take a while)..."
      - |
        pre-commit run --all-files || {
          echo "âš ï¸  Some checks failed. This is normal for first-time setup."
          echo "ğŸ’¡ The hooks will now run automatically on git commit."
          echo "ğŸ’¡ To run manually: pre-commit run --all-files"
          echo "ğŸ’¡ To update hooks: pre-commit autoupdate"
          exit 0
        }
      - echo "âœ¨ Pre-commit setup complete!"
      - echo ""
      - echo "ğŸ“š Usage:"
      - 'echo "  â€¢ Hooks run automatically on: git commit"'
      - 'echo "  â€¢ Run manually on all files: pre-commit run --all-files"'
      - 'echo "  â€¢ Run on specific files: pre-commit run --files <file1> <file2>"'
      - 'echo "  â€¢ Skip hooks (not recommended): git commit --no-verify"'
      - 'echo "  â€¢ Update hooks to latest: pre-commit autoupdate"'

  test:
    desc: Run all unit tests (required before build)
    deps:
      - test:api
      - test:demo
      - test:demo-agent
    cmds:
      - echo "ğŸ§ª Running unit tests..."
      - echo "âœ… All tests passed"

  test:api:
    desc: Run API unit tests
    deps: [install:api]
    dir: apps/api
    cmds:
      - |
        if [ -f "pyproject.toml" ] && grep -q "pytest" pyproject.toml; then
          echo "Running API tests..."
          uv run pytest tests/ -v || exit 1
        else
          echo "âš ï¸  No tests configured for API (skipping)"
        fi

  test:demo:
    desc: Run demo unit tests
    deps: [install:demo]
    dir: apps/demo
    cmds:
      - |
        if [ -f "test_demo.py" ]; then
          echo "Running demo tests..."
          uv run pytest test_demo.py -v || exit 1
        else
          echo "âš ï¸  No tests found for demo (skipping)"
        fi

  test:demo-agent:
    desc: Run demo-agent unit tests
    deps: [install:demo-agent]
    dir: apps/demo-otel-agent
    cmds:
      - |
        if [ -f "test_agent.py" ]; then
          echo "Running demo-agent tests..."
          uv run pytest test_agent.py -v || exit 1
        else
          echo "âš ï¸  No tests found for demo-agent (skipping)"
        fi

  test:web-ui:
    desc: Run web UI tests
    dir: apps/web-ui
    cmds:
      - |
        if [ -f "package.json" ] && grep -q "vitest" package.json; then
          echo "Running web UI tests..."
          npm install --silent 2>/dev/null || true
          npm test || exit 1
        else
          echo "âš ï¸  No tests configured for web-ui (skipping)"
        fi

  validate:
    desc: Run all validation (lint + tests) before build
    deps:
      - lint
    cmds:
      - echo "âœ… All validation passed"

  # ====================
  # Container Image Building
  # ====================

  build:image:
    desc: Build all container images (runs validation first)
    deps:
      - build:image:api
      - build:image:web-ui
      - build:image:opamp
      - build:image:demo
      - build:image:demo-agent

  build:image:api:
    desc: Build API backend image
    deps: [test:api]
    cmds:
      - echo "ğŸ”¨ Building API Backend..."
      - date +"Build started at %Y-%m-%d %H:%M:%S"
      - echo "{{.VERSION}}" > .task-version-api
      - |
        {{.CONTAINER_RUNTIME}} build \
          --layers \
          -f apps/api/Dockerfile \
          -t {{.PROJECT_SLUG}}/api:{{.VERSION}} \
          -t {{.EXTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/api:{{.VERSION}} \
          --platform {{.BUILD_PLATFORMS}} \
          apps/api/
      - date +"Build completed at %Y-%m-%d %H:%M:%S"
      - echo "âœ… API Backend built"

  build:image:web-ui:
    desc: Build web UI image
    deps: [test:web-ui]
    cmds:
      - echo "ğŸ”¨ Building Web UI..."
      - date +"Build started at %Y-%m-%d %H:%M:%S"
      - echo "{{.VERSION}}" > .task-version-web-ui
      - |
        {{.CONTAINER_RUNTIME}} build \
          --layers \
          -f apps/web-ui/Dockerfile \
          -t {{.PROJECT_SLUG}}/web-ui:{{.VERSION}} \
          -t {{.EXTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/web-ui:{{.VERSION}} \
          --platform {{.BUILD_PLATFORMS}} \
          apps/web-ui/
      - date +"Build completed at %Y-%m-%d %H:%M:%S"
      - echo "âœ… Web UI built"

  build:image:opamp:
    desc: Build OpAMP server image
    deps: []
    cmds:
      - echo "ğŸ”¨ Building OpAMP Server..."
      - date +"Build started at %Y-%m-%d %H:%M:%S"
      - echo "{{.VERSION}}" > .task-version-opamp
      - |
        {{.CONTAINER_RUNTIME}} build \
          --layers \
          -f apps/opamp-server/Dockerfile \
          -t {{.PROJECT_SLUG}}/opamp-server:{{.VERSION}} \
          -t {{.EXTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/opamp-server:{{.VERSION}} \
          --platform {{.BUILD_PLATFORMS}} \
          apps/opamp-server/
      - date +"Build completed at %Y-%m-%d %H:%M:%S"
      - echo "âœ… OpAMP Server built"

  build:image:demo:
    desc: Build unified demo image
    deps: [test:demo]
    cmds:
      - echo "ğŸ”¨ Building Unified Demo..."
      - date +"Build started at %Y-%m-%d %H:%M:%S"
      - echo "{{.VERSION}}" > .task-version-demo
      - |
        {{.CONTAINER_RUNTIME}} build \
          --layers \
          -f apps/demo/Dockerfile \
          -t {{.PROJECT_SLUG}}/demo:{{.VERSION}} \
          -t {{.EXTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/demo:{{.VERSION}} \
          --platform {{.BUILD_PLATFORMS}} \
          apps/demo/
      - date +"Build completed at %Y-%m-%d %H:%M:%S"
      - echo "âœ… Unified Demo built"

  build:image:demo-agent:
    desc: Build AI agent demo image
    deps: [test:demo-agent]
    cmds:
      - echo "ğŸ”¨ Building AI Agent Demo..."
      - date +"Build started at %Y-%m-%d %H:%M:%S"
      - echo "{{.VERSION}}" > .task-version-demo-agent
      - |
        {{.CONTAINER_RUNTIME}} build \
          --layers \
          -f apps/demo-otel-agent/Dockerfile \
          -t {{.PROJECT_SLUG}}/demo-otel-agent:{{.VERSION}} \
          -t {{.EXTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/demo-otel-agent:{{.VERSION}} \
          --platform {{.BUILD_PLATFORMS}} \
          apps/demo-otel-agent/
      - date +"Build completed at %Y-%m-%d %H:%M:%S"
      - echo "âœ… AI Agent Demo built"

  # ====================
  # Helm Charts - Build
  # ====================

  build:chart:
    desc: Build (package) all Helm charts
    deps:
      - build:chart:ollyscale
      - build:chart:postgres
      - build:chart:otel
      - build:chart:demos
      - build:chart:otel-agent

  build:chart:ollyscale:
    desc: Package ollyscale Helm chart
    deps: [build:image:api, build:image:web-ui, build:image:opamp]
    dir: charts
    vars:
      VERSION:
        sh: echo "${VERSION:-0.0.0-dev.$(date +%s)}"
      VERSION_API:
        sh: cat ../.task-version-api
      VERSION_WEB_UI:
        sh: cat ../.task-version-web-ui
      VERSION_OPAMP:
        sh: cat ../.task-version-opamp
      CHART_DIR: ollyscale
      NEW_VERSION: "0.0.0-{{.VERSION}}"
    cmds:
      - echo "{{.VERSION}}" > ../.task-version-chart-ollyscale
      - echo "ğŸ“¦ Packaging ollyscale Helm chart..."
      - 'echo "Chart version: {{.NEW_VERSION}}"'
      - 'echo "API image version: {{.VERSION_API}}"'
      - 'echo "Web UI image version: {{.VERSION_WEB_UI}}"'
      - 'echo "OpAMP image version: {{.VERSION_OPAMP}}"'
      - |
        if [ -z "${CI:-}" ]; then
          # Local build: set chart version via helm flags (terraform handles image tag overrides)
          helm package {{.CHART_DIR}} --version "{{.NEW_VERSION}}" --app-version "{{.VERSION_API}}"
        else
          # CI build: release-please already updated Chart.yaml and values.yaml
          helm package {{.CHART_DIR}}
        fi
      - 'echo "âœ… Chart packaged: ollyscale-{{.NEW_VERSION}}"'

  # Postgres Chart - with file-based dependency tracking
  test:chart:postgres:
    desc: Test postgres chart with chart-testing (ct)
    dir: charts/ollyscale-postgres
    preconditions:
      - sh: command -v helm >/dev/null 2>&1
        msg: "helm must be installed"
    sources:
      - "**/*.yaml"
      - "**/*.tpl"
      - Chart.yaml
      - values.yaml
    cmds:
      - |
        echo "ğŸ§ª Testing postgres chart with helm lint..."
        helm lint .

        # Only run ct if both ct and yamllint are available
        if command -v ct >/dev/null 2>&1; then
          if command -v yamllint >/dev/null 2>&1; then
            echo "ğŸ§ª Running chart-testing lint..."
            cd .. && ct lint --config ollyscale-postgres/ct.yaml --charts ollyscale-postgres
          else
            echo "âš ï¸  yamllint not found - skipping chart-testing"
            echo "   Install with: brew install yamllint (macOS) or pip install yamllint"
          fi
        else
          echo "â„¹ï¸  chart-testing (ct) not found - helm lint only"
          echo "   Install with: brew install chart-testing (optional)"
        fi

        echo "âœ… Postgres chart tests passed"

  build:chart:postgres:
    desc: Package ollyscale-postgres Helm chart (only if source files changed)
    deps: [test:chart:postgres]
    dir: charts
    sources:
      - "ollyscale-postgres/**/*.yaml"
      - "ollyscale-postgres/**/*.tpl"
      - ollyscale-postgres/Chart.yaml
      - ollyscale-postgres/values.yaml
    generates:
      - "ollyscale-postgres-*.tgz"
    cmds:
      - |
        # Generate proper semver version with dev timestamp for local builds
        VERSION="0.0.0-dev.$(date +%s)"
        echo "$VERSION" > ../.task-version-chart-postgres
        echo "ğŸ“¦ Packaging ollyscale-postgres Helm chart..."
        echo "Chart version: $VERSION"

        if [ -z "${CI:-}" ]; then
          # Local build: update Chart.yaml with dev version, package, then restore
          cp ollyscale-postgres/Chart.yaml ollyscale-postgres/Chart.yaml.bak
          sed -i.tmp "s/^version: .*/version: $VERSION/" ollyscale-postgres/Chart.yaml
          rm -f ollyscale-postgres/Chart.yaml.tmp
          helm package ollyscale-postgres
          mv ollyscale-postgres/Chart.yaml.bak ollyscale-postgres/Chart.yaml
        else
          # CI build: release-please already updated Chart.yaml
          helm package ollyscale-postgres
          CI_VERSION=$(yq eval '.version' ollyscale-postgres/Chart.yaml)
          echo "$CI_VERSION" > ../.task-version-chart-postgres
          VERSION="$CI_VERSION"
        fi

        echo "âœ… Chart packaged: ollyscale-postgres-$VERSION.tgz"

  build:chart:otel:
    desc: Package ollyscale-otel Helm chart (only if source files changed)
    dir: charts
    sources:
      - "ollyscale-otel/**/*.yaml"
      - "ollyscale-otel/**/*.tpl"
      - ollyscale-otel/Chart.yaml
      - ollyscale-otel/values.yaml
    generates:
      - "ollyscale-otel-*.tgz"
    cmds:
      - |
        # Generate proper semver version with dev timestamp for local builds
        VERSION="0.0.0-dev.$(date +%s)"
        echo "$VERSION" > ../.task-version-chart-otel
        echo "ğŸ“¦ Packaging ollyscale-otel Helm chart..."
        echo "Chart version: $VERSION"

        if [ -z "${CI:-}" ]; then
          # Local build: update Chart.yaml with dev version, package, then restore
          cp ollyscale-otel/Chart.yaml ollyscale-otel/Chart.yaml.bak
          sed -i.tmp "s/^version: .*/version: $VERSION/" ollyscale-otel/Chart.yaml
          rm -f ollyscale-otel/Chart.yaml.tmp
          helm package ollyscale-otel
          mv ollyscale-otel/Chart.yaml.bak ollyscale-otel/Chart.yaml
        else
          # CI build: release-please already updated Chart.yaml
          helm package ollyscale-otel
          CI_VERSION=$(yq eval '.version' ollyscale-otel/Chart.yaml)
          echo "$CI_VERSION" > ../.task-version-chart-otel
          VERSION="$CI_VERSION"
        fi

        echo "âœ… Chart packaged: ollyscale-otel-$VERSION.tgz"

  build:chart:demos:
    desc: Package ollyscale-demos Helm chart
    deps: [build:image:demo]
    dir: charts
    vars:
      VERSION:
        sh: echo "${VERSION:-0.0.0-dev.$(date +%s)}"
      VERSION_DEMO:
        sh: cat ../.task-version-demo
      CHART_DIR: ollyscale-demos
      NEW_VERSION: "0.0.0-{{.VERSION}}"
    cmds:
      - echo "{{.VERSION}}" > ../.task-version-chart-demos
      - echo "ğŸ“¦ Packaging ollyscale-demos Helm chart..."
      - 'echo "Chart version: {{.NEW_VERSION}}"'
      - 'echo "Demo image version: {{.VERSION_DEMO}}"'
      - |
        if [ -z "${CI:-}" ]; then
          # Local build: set chart version via helm flags (terraform handles image tag overrides)
          helm package {{.CHART_DIR}} --version "{{.NEW_VERSION}}" --app-version "{{.VERSION_DEMO}}"
        else
          # CI build: release-please already updated Chart.yaml and values.yaml
          helm package {{.CHART_DIR}}
        fi
      - 'echo "âœ… Chart packaged: ollyscale-demos-{{.NEW_VERSION}}"'

  build:chart:otel-agent:
    desc: Package ollyscale-otel-agent Helm chart
    deps: [build:image:demo-agent]
    dir: charts
    vars:
      VERSION:
        sh: echo "${VERSION:-0.0.0-dev.$(date +%s)}"
      VERSION_DEMO_AGENT:
        sh: cat ../.task-version-demo-agent
      CHART_DIR: ollyscale-otel-agent
      NEW_VERSION: "0.0.0-{{.VERSION}}"
    cmds:
      - echo "{{.VERSION}}" > ../.task-version-chart-otel-agent
      - echo "ğŸ“¦ Packaging ollyscale-otel-agent Helm chart..."
      - 'echo "Chart version: {{.NEW_VERSION}}"'
      - 'echo "Demo agent image version: {{.VERSION_DEMO_AGENT}}"'
      - |
        if [ -z "${CI:-}" ]; then
          # Local build: set chart version via helm flags (terraform handles image tag overrides)
          helm package {{.CHART_DIR}} --version "{{.NEW_VERSION}}" --app-version "{{.VERSION_DEMO_AGENT}}"
        else
          # CI build: release-please already updated Chart.yaml and values.yaml
          helm package {{.CHART_DIR}}
        fi
      - 'echo "âœ… Chart packaged: ollyscale-otel-agent-{{.NEW_VERSION}}"'

  # ====================
  # Build All
  # ====================

  build:
    desc: Build all images and charts
    deps:
      - build:image
      - build:chart

  # ====================
  # Push Images
  # ====================

  push:image:
    desc: Push all images to registry
    deps:
      - push:image:api
      - push:image:web-ui
      - push:image:opamp
      - push:image:demo
      - push:image:demo-agent

  push:image:api:
    desc: Push API image
    deps: [build:image:api]
    cmds:
      - echo "ğŸ“¤ Pushing API Backend..."
      - "{{.CONTAINER_RUNTIME}} push {{.PUSH_FLAGS}} {{.EXTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/api:$(cat .task-version-api)"
      - echo "âœ… API Backend pushed"

  push:image:web-ui:
    desc: Push web UI image
    deps: [build:image:web-ui]
    cmds:
      - echo "ğŸ“¤ Pushing Web UI..."
      - "{{.CONTAINER_RUNTIME}} push {{.PUSH_FLAGS}} {{.EXTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/web-ui:$(cat .task-version-web-ui)"
      - echo "âœ… Web UI pushed"

  push:image:opamp:
    desc: Push OpAMP server image
    deps: [build:image:opamp]
    cmds:
      - echo "ğŸ“¤ Pushing OpAMP Server..."
      - "{{.CONTAINER_RUNTIME}} push {{.PUSH_FLAGS}} {{.EXTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/opamp-server:$(cat .task-version-opamp)"
      - echo "âœ… OpAMP Server pushed"

  push:image:demo:
    desc: Push unified demo image
    deps: [build:image:demo]
    cmds:
      - echo "ğŸ“¤ Pushing Unified Demo..."
      - "{{.CONTAINER_RUNTIME}} push {{.PUSH_FLAGS}} {{.EXTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/demo:$(cat .task-version-demo)"
      - echo "âœ… Unified Demo pushed"

  push:image:demo-agent:
    desc: Push AI agent demo image
    deps: [build:image:demo-agent]
    cmds:
      - echo "ğŸ“¤ Pushing AI Agent Demo..."
      - "{{.CONTAINER_RUNTIME}} push {{.PUSH_FLAGS}} {{.EXTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/demo-otel-agent:$(cat .task-version-demo-agent)"
      - echo "âœ… AI Agent Demo pushed"

  # ====================
  # Helm Charts - Push
  # ====================

  push:chart:
    desc: Push all Helm charts to registry
    deps:
      - push:chart:ollyscale
      - push:chart:postgres
      - push:chart:otel
      - push:chart:demos
      - push:chart:otel-agent

  push:chart:ollyscale:
    desc: Push ollyscale Helm chart
    deps: [build:chart:ollyscale]
    dir: charts
    cmds:
      - echo "ğŸ“¤ Pushing ollyscale chart..."
      - |
        VERSION=$(cat ../.task-version-chart-ollyscale)
        helm push ollyscale-0.0.0-${VERSION}.tgz oci://{{.EXTERNAL_CHART_REGISTRY}} --insecure-skip-tls-verify
        echo "âœ… Chart pushed: ollyscale-0.0.0-${VERSION}"

  has-pushed:chart:postgres:
    desc: Check if postgres chart version is already pushed to registry
    dir: charts
    vars:
      CHART_VERSION:
        sh: yq eval '.version' ollyscale-postgres/Chart.yaml
    cmds:
      - |
        set +e
        echo "Checking if ollyscale-postgres:{{.CHART_VERSION}} already exists in registry..."

        # Try to pull from remote registry (GHCR)
        helm pull oci://ghcr.io/{{.REGISTRY_ORG}}/{{.PROJECT_SLUG}}/charts/ollyscale-postgres \
          --version {{.CHART_VERSION}} \
          --destination /tmp \
          2>&1 | tee /tmp/helm-check.log

        if grep -q "Error" /tmp/helm-check.log; then
          echo "Version {{.CHART_VERSION}} not found in registry - OK to push"
          rm -f /tmp/helm-check.log
          exit 1
        else
          echo "âš ï¸  Version {{.CHART_VERSION}} already exists in registry - skipping push"
          rm -f /tmp/helm-check.log /tmp/ollyscale-postgres-{{.CHART_VERSION}}.tgz
          exit 0
        fi
    silent: false

  push:chart:postgres:
    desc: Push ollyscale-postgres Helm chart to registry (only if .tgz changed)
    deps: [build:chart:postgres]
    dir: charts
    cmds:
      - |
        # Get version - try version file first, but validate .tgz exists
        if [ -f ../.task-version-chart-postgres ]; then
          CHART_VERSION=$(cat ../.task-version-chart-postgres)
          # Validate the .tgz actually exists for this version
          if [ ! -f "ollyscale-postgres-$CHART_VERSION.tgz" ]; then
            echo "Warning: Version file points to $CHART_VERSION but .tgz doesn't exist"
            CHART_VERSION=""
          fi
        fi

        # If version file didn't work, find the existing .tgz
        if [ -z "$CHART_VERSION" ]; then
          CHART_VERSION=$(ls ollyscale-postgres-*.tgz 2>/dev/null | head -1 | sed 's/ollyscale-postgres-\(.*\)\.tgz/\1/')
          if [ -z "$CHART_VERSION" ]; then
            echo "Error: No chart package found"
            exit 1
          fi
          echo "Using chart version from existing package: $CHART_VERSION"
        fi

        # Check if version already pushed (CI only - local builds use unique timestamp versions)
        if [ -n "${CI:-}" ] && task has-pushed:chart:postgres 2>/dev/null; then
          echo "â­ï¸  Postgres chart version $CHART_VERSION already pushed"
          # Still update auto vars for consistency
          cat > ../.kind/postgres.auto.tfvars <<EOF
        # Auto-generated by task push:chart:postgres
        # Chart: ollyscale-postgres
        # Version: $CHART_VERSION
        # Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

        postgres_chart_tag = "$CHART_VERSION"
        EOF
          exit 0
        fi

        echo "ğŸ“¤ Pushing ollyscale-postgres chart..."

        # Push to local registry (always for dev)
        helm push ollyscale-postgres-$CHART_VERSION.tgz \
          oci://{{.EXTERNAL_CHART_REGISTRY}} \
          --insecure-skip-tls-verify

        # Push to GHCR in CI or if configured
        if [ -n "${CI:-}" ] || [ -n "${PUSH_TO_GHCR:-}" ]; then
          echo "ğŸ“¤ Pushing to GitHub Container Registry..."
          helm push ollyscale-postgres-$CHART_VERSION.tgz \
            oci://ghcr.io/{{.REGISTRY_ORG}}/{{.PROJECT_SLUG}}/charts
        fi

        echo "âœ… Chart pushed: ollyscale-postgres-$CHART_VERSION"

        # Update auto vars file
        echo "ğŸ“ Updating .kind/postgres.auto.tfvars..."
        cat > ../.kind/postgres.auto.tfvars <<EOF
        # Auto-generated by task push:chart:postgres
        # Chart: ollyscale-postgres
        # Version: $CHART_VERSION
        # Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

        postgres_chart_tag = "$CHART_VERSION"
        EOF
        echo "âœ… Auto vars updated"

  push:chart:otel:
    desc: Push ollyscale-otel Helm chart to registry
    deps: [build:chart:otel]
    dir: charts
    cmds:
      - |
        # Get version - try version file first, but validate .tgz exists
        if [ -f ../.task-version-chart-otel ]; then
          CHART_VERSION=$(cat ../.task-version-chart-otel)
          # Validate the .tgz actually exists for this version
          if [ ! -f "ollyscale-otel-$CHART_VERSION.tgz" ]; then
            echo "Warning: Version file points to $CHART_VERSION but .tgz doesn't exist"
            CHART_VERSION=""
          fi
        fi

        # If version file didn't work, find the existing .tgz
        if [ -z "$CHART_VERSION" ]; then
          CHART_VERSION=$(ls ollyscale-otel-*.tgz 2>/dev/null | head -1 | sed 's/ollyscale-otel-\(.*\)\.tgz/\1/')
          if [ -z "$CHART_VERSION" ]; then
            echo "Error: No chart package found"
            exit 1
          fi
          echo "Using chart version from existing package: $CHART_VERSION"
        fi

        echo "ğŸ“¤ Pushing ollyscale-otel chart..."

        # Push to local registry (always for dev)
        helm push ollyscale-otel-$CHART_VERSION.tgz \
          oci://{{.EXTERNAL_CHART_REGISTRY}} \
          --insecure-skip-tls-verify

        # Push to GHCR in CI or if configured
        if [ -n "${CI:-}" ] || [ -n "${PUSH_TO_GHCR:-}" ]; then
          echo "ğŸ“¤ Pushing to GitHub Container Registry..."
          helm push ollyscale-otel-$CHART_VERSION.tgz \
            oci://ghcr.io/{{.REGISTRY_ORG}}/{{.PROJECT_SLUG}}/charts
        fi

        echo "âœ… Chart pushed: ollyscale-otel-$CHART_VERSION"

        # Update auto vars file
        echo "ğŸ“ Updating .kind/otel.auto.tfvars..."
        cat > ../.kind/otel.auto.tfvars <<EOF
        # Auto-generated by task push:chart:otel
        # Chart: ollyscale-otel
        # Version: $CHART_VERSION
        # Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

        ollyscale_otel_chart_tag = "$CHART_VERSION"
        EOF
        echo "âœ… Auto vars updated"

  push:chart:demos:
    desc: Push ollyscale-demos Helm chart
    deps: [build:chart:demos]
    dir: charts
    cmds:
      - echo "ğŸ“¤ Pushing ollyscale-demos chart..."
      - |
        VERSION=$(cat ../.task-version-chart-demos)
        helm push ollyscale-demos-0.0.0-${VERSION}.tgz oci://{{.EXTERNAL_CHART_REGISTRY}} --insecure-skip-tls-verify
        echo "âœ… Chart pushed: ollyscale-demos-0.0.0-${VERSION}"

  push:chart:otel-agent:
    desc: Push ollyscale-otel-agent Helm chart
    deps: [build:chart:otel-agent]
    dir: charts
    cmds:
      - echo "ğŸ“¤ Pushing ollyscale-otel-agent chart..."
      - |
        VERSION=$(cat ../.task-version-chart-otel-agent)
        helm push ollyscale-otel-agent-0.0.0-${VERSION}.tgz oci://{{.EXTERNAL_CHART_REGISTRY}} --insecure-skip-tls-verify
        echo "âœ… Chart pushed: ollyscale-otel-agent-0.0.0-${VERSION}"

  # ====================
  # Push All
  # ====================

  push:
    desc: Push all images and charts
    deps:
      - push:image
      - push:chart

  # ====================
  # Complete Build & Deploy
  # ====================

  build-and-push:
    desc: Build and push all images and charts (validates first)
    deps:
      - push
    cmds:
      - echo "âœ… Build complete!"
      - echo ""
      - echo "Container Images:"
      - 'echo "  â€¢ Built/pushed to: {{.EXTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/*:{{.VERSION}}"'
      - echo ""
      - echo "Helm Charts:"
      - 'echo "  â€¢ External: oci://{{.EXTERNAL_CHART_REGISTRY}}"'
      - 'echo "  â€¢ Internal: oci://{{.INTERNAL_CHART_REGISTRY}}"'

  deploy:
    desc: Build, push, and deploy to local KIND cluster (replaces make deploy)
    deps:
      - build-and-push
    cmds:
      - echo "ğŸ”„ Updating terraform auto vars..."
      - |
        VERSION_CHART_OLLYSCALE=$(cat .task-version-chart-ollyscale)
        VERSION_CHART_POSTGRES=$(cat .task-version-chart-postgres 2>/dev/null || yq eval '.version' charts/ollyscale-postgres/Chart.yaml)
        VERSION_CHART_OTEL=$(cat .task-version-chart-otel 2>/dev/null || yq eval '.version' charts/ollyscale-otel/Chart.yaml)
        VERSION_CHART_OTEL_AGENT=$(cat .task-version-chart-otel-agent)
        VERSION_API=$(cat .task-version-api)
        VERSION_OPAMP=$(cat .task-version-opamp)
        VERSION_DEMO_AGENT=$(cat .task-version-demo-agent)
        cat > .kind/terraform.auto.tfvars <<EOF
        ollyscale_chart_tag = "0.0.0-${VERSION_CHART_OLLYSCALE}"
        postgres_chart_tag = "${VERSION_CHART_POSTGRES}"
        ollyscale_otel_chart_tag = "${VERSION_CHART_OTEL}"
        ollyscale_tag = "${VERSION_API}"
        opamp_tag = "${VERSION_OPAMP}"
        ai_agent_chart_tag = "0.0.0-${VERSION_CHART_OTEL_AGENT}"
        ai_agent_image = "{{.INTERNAL_REGISTRY}}/{{.PROJECT_SLUG}}/demo-otel-agent"
        ai_agent_tag = "${VERSION_DEMO_AGENT}"
        EOF
      - echo "ğŸ”„ Applying terraform configuration..."
      - cd .kind && terraform apply -auto-approve
      - echo "âœ… Deployment complete!"

  # ====================
  # KIND Cluster Management
  # ====================

  up:
    desc: Create KIND cluster (replaces make up)
    dir: .kind
    cmds:
      - |
        if [ ! -f terraform.tfstate ]; then
          terraform init
        fi
      - |
        if ! kind get clusters 2>/dev/null | grep -q "^{{.CLUSTER_NAME}}$$"; then
          echo "ğŸš€ Creating new cluster..."
          export TF_VAR_bootstrap=true
          terraform apply -auto-approve
          echo "â³ Waiting for Gateway API CRDs..."
          sleep 30
          for i in {1..10}; do
            if kubectl get crd gateways.gateway.networking.k8s.io httproutes.gateway.networking.k8s.io 2>/dev/null; then
              echo "âœ… Gateway API CRDs ready!"
              kubectl wait --for condition=established --timeout=60s crd/gateways.gateway.networking.k8s.io crd/httproutes.gateway.networking.k8s.io
              break
            fi
            echo "  Attempt $i/10: CRDs not found, waiting..."
            sleep 30
          done
          echo "ğŸ”„ Second pass to enable HTTPRoutes..."
          export TF_VAR_bootstrap=false
          terraform apply -auto-approve
        else
          echo "â™»ï¸  Updating existing cluster..."
          export TF_VAR_bootstrap=false
          terraform apply -auto-approve
        fi
      - echo "âœ… KIND cluster ready!"

  down:
    desc: Destroy KIND cluster (replaces make down)
    cmds:
      - echo "Deleting KIND cluster..."
      - kind delete cluster --name {{.CLUSTER_NAME}} || true
      - rm -f .kind/terraform.tfstate .kind/terraform.tfstate.backup
      - echo "âœ… Cleanup complete!"

  clean:
    desc: Clean build artifacts and caches
    cmds:
      - rm -f charts/*.tgz
      - echo "âœ… Build artifacts cleaned"

  clean:cache:
    desc: Clean container build cache (run when cache fills up)
    cmds:
      - echo "ğŸ—‘ï¸  Cleaning container build cache..."
      - |
        if [ "{{.CONTAINER_RUNTIME}}" = "podman" ]; then
          podman system prune -f
          echo "âœ… Podman build cache cleaned"
        else
          docker builder prune -f
          echo "âœ… Docker build cache cleaned"
        fi

  # ====================
  # CI-specific Tasks
  # ====================

  ci:build:
    desc: Build images for CI (uses Docker buildx with multi-arch)
    deps:
      - build
    env:
      CI: "true"

  ci:push-ghcr:
    desc: Push images to GitHub Container Registry (CI only)
    cmds:
      - echo "ğŸ“¤ Pushing to GitHub Container Registry..."
      - |
        for image in api web-ui opamp-server demo demo-otel-agent; do
          echo "Pushing ${image}..."
          docker tag {{.PROJECT_SLUG}}/${image}:{{.VERSION}} {{.IMAGE_PREFIX}}/${image}:{{.VERSION}}
          docker push {{.IMAGE_PREFIX}}/${image}:{{.VERSION}}
        done
      - echo "âœ… All images pushed to GHCR"

  ci:build-all:
    desc: Build all images for CI (skips validation)
    deps:
      - build:image:api
      - build:image:web-ui
      - build:image:opamp
      - build:image:demo
      - build:image:demo-agent
    env:
      CI: "true"

  default:
    desc: Show available tasks
    cmds:
      - task --list
