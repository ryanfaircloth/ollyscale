# Default values for ollyscale-otel
# This chart deploys OpenTelemetry collector infrastructure for OllyScale
# Must be deployed to otel-system namespace

global:
  # Namespace where collectors and instrumentation will be deployed
  namespace: otel-system
  # Namespace where OllyScale application (OpAMP server, OTLP receiver) is deployed
  ollyscaleNamespace: ollyscale

commonLabels: {}
commonAnnotations: {}

# Agent Collector - DaemonSet mode, runs on each node
agentCollector:
  enabled: true
  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
    processors:
      batch:
        timeout: 5s
        send_batch_size: 256
    exporters:
      # Load balance to gateway collectors within otel-system namespace
      loadbalancing/gateway:
        resolver:
          dns:
            hostname: gateway-collector-headless.otel-system.svc.cluster.local
            port: '4317'
        protocol:
          otlp:
            tls:
              insecure: true
    service:
      pipelines:
        traces:
          receivers:
            - otlp
          processors:
            - batch
          exporters:
            - loadbalancing/gateway
        metrics:
          receivers:
            - otlp
          processors:
            - batch
          exporters:
            - loadbalancing/gateway
        logs:
          receivers:
            - otlp
          processors:
            - batch
          exporters:
            - loadbalancing/gateway

# Gateway Collector - Aggregates and processes telemetry
gatewayCollector:
  enabled: true
  replicas: 1
  podAnnotations: {}
  resources:
    limits:
      memory: 1Gi
    requests:
      cpu: 200m
      memory: 512Mi
  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
    processors:
      batch:
        timeout: 5s
        send_batch_size: 256
      # Tail sampling - keeps errors, samples successful traces
      tail_sampling:
        decision_wait: 10s
        num_traces: 50000
        expected_new_traces_per_sec: 100
        policies:
          # Keep all error traces
          - name: errors
            type: status_code
            status_code:
              status_codes:
                - ERROR
          # Keep HTTP error responses
          - name: http-errors
            type: string_attribute
            string_attribute:
              key: http.status_code
              values:
                - 4[0-9]{2}
                - 5[0-9]{2}
              enabled_regex_matching: true
          # Keep all demo application traces
          - name: keep-demos
            type: string_attribute
            string_attribute:
              key: service.name
              values:
                - demo-.*
                - otel-demo-.*
                - ai-agent.*
              enabled_regex_matching: true
          # Keep traces from non-ollyscale services
          - name: keep-non-ollyscale
            type: and
            and:
              and_sub_policy:
                - name: not-ollyscale
                  type: string_attribute
                  string_attribute:
                    key: service.name
                    values:
                      - ollyscale-.*
                    enabled_regex_matching: true
                    invert_match: true
          # Sample 5% of successful ollyscale service traces
          - name: sample-ollyscale-success
            type: and
            and:
              and_sub_policy:
                - name: ollyscale-services
                  type: string_attribute
                  string_attribute:
                    key: service.name
                    values:
                      - ollyscale-.*
                    enabled_regex_matching: true
                - name: not-error
                  type: status_code
                  status_code:
                    status_codes:
                      - OK
                      - UNSET
                - name: probabilistic
                  type: probabilistic
                  probabilistic:
                    sampling_percentage: 5
    exporters:
      # Export to OllyScale OTLP receiver in ollyscale namespace
      otlp/to:
        endpoint: ollyscale-otlp-receiver.ollyscale.svc.cluster.local:4343
        tls:
          insecure: true
    extensions:
      # OpAMP server connection (in ollyscale namespace)
      opamp:
        server:
          ws:
            endpoint: ws://ollyscale-opamp-server.ollyscale.svc.cluster.local:4320/v1/opamp
    service:
      extensions:
        - opamp
      pipelines:
        traces:
          receivers:
            - otlp
          processors:
            - tail_sampling
            - batch
          exporters:
            - otlp/to
        metrics:
          receivers:
            - otlp
          processors:
            - batch
          exporters:
            - otlp/to
        logs:
          receivers:
            - otlp
          processors:
            - batch
          exporters:
            - otlp/to

# Browser Collector - HTTP-only for RUM data
browserCollector:
  enabled: true
  replicas: 1
  podAnnotations: {}
  resources:
    limits:
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi
  config:
    receivers:
      otlp:
        protocols:
          http:
            endpoint: 0.0.0.0:4318
    processors:
      batch:
        timeout: 1s
        send_batch_size: 100
      resource:
        attributes:
          - key: telemetry.source
            value: browser
            action: upsert
    exporters:
      # Load balance to gateway collectors
      loadbalancing/gateway:
        resolver:
          dns:
            hostname: gateway-collector-headless.otel-system.svc.cluster.local
            port: '4317'
        protocol:
          otlp:
            tls:
              insecure: true
    service:
      pipelines:
        traces:
          receivers:
            - otlp
          processors:
            - resource
            - batch
          exporters:
            - loadbalancing/gateway

# Instrumentation CR for auto-instrumentation
instrumentation:
  enabled: true
  selfObservability: true
  name: ollyscale-instrumentation
  exporter:
    # Send to agent collector in otel-system namespace
    endpoint: http://agent-collector.otel-system.svc.cluster.local:4318
  propagators:
    - tracecontext
    - baggage
  sampler:
    type: always_on
  resource:
    addK8sUIDAttributes: true
  python:
    image:
      repository: ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-python
      tag: 0.60b1
    env:
      - name: OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED
        value: 'true'
      - name: OTEL_PYTHON_LOGGING_INJECTION_ENABLED
        value: 'true'
      - name: OTEL_PYTHON_LOG_LEVEL
        value: INFO
      - name: OTEL_PYTHON_LOG_CORRELATION
        value: 'true'
      - name: OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_SERVER_REQUEST
        value: content-.*,x-.*
      - name: OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_SERVER_RESPONSE
        value: content-.*,x-.*
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
  go:
    resources:
      requests:
        cpu: 50m
        memory: 64Mi

# eBPF Agent - Optional network instrumentation
ebpfAgent:
  enabled: false
  image:
    repository: docker.io/otel/ebpf-instrument
    tag: v0.4.1
    pullPolicy: Always
  podAnnotations: {}
  podSecurityContext:
    hostPID: true
  securityContext:
    privileged: true
    runAsUser: 0
    readOnlyRootFilesystem: false
  resources:
    limits:
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi
  config:
    # Send to gateway collector in otel-system namespace
    otlpEndpoint: http://gateway-collector.otel-system.svc.cluster.local:4317
    openPorts: '5000'
    serviceName: ebpf-demo
  nodeSelector: {}
  tolerations: []
  affinity: {}

# ConfigMap with OTel collector templates for OpAMP-managed collectors
otelTemplates:
  enabled: true
  templates: {}
