{{- if .Values.partitionMaintenance.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "ollyscale.fullname" . }}-partition-maintenance
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "ollyscale.labels" . | nindent 4 }}
    app.kubernetes.io/component: partition-maintenance
spec:
  schedule: {{ .Values.partitionMaintenance.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            {{- include "ollyscale.selectorLabels" . | nindent 12 }}
            app.kubernetes.io/component: partition-maintenance
        spec:
          restartPolicy: OnFailure
          {{- with .Values.partitionMaintenance.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.partitionMaintenance.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          containers:
            - name: partition-maintenance
              image: "{{ .Values.api.image.repository }}:{{ .Values.api.image.tag | default .Chart.AppVersion }}"
              imagePullPolicy: {{ .Values.api.image.pullPolicy }}
              command:
                - /bin/sh
                - -c
                - |
                  echo "=== Starting partition maintenance ==="
                  echo "Current time: $(date)"
                  echo "Days ahead: {{ .Values.partitionMaintenance.daysAhead }}"
                  echo ""

                  # Read DATABASE_URL from secret file
                  export DATABASE_URL=$(cat /secrets/db/uri)

                  echo "Creating future partitions..."
                  psql "$DATABASE_URL" -c "SELECT * FROM maintenance_create_partitions({{ .Values.partitionMaintenance.daysAhead }});"
                  CREATE_EXIT=$?

                  echo ""
                  echo "Dropping old partitions..."
                  psql "$DATABASE_URL" -c "SELECT * FROM maintenance_drop_partitions();"
                  DROP_EXIT=$?

                  echo ""
                  if [ $CREATE_EXIT -eq 0 ] && [ $DROP_EXIT -eq 0 ]; then
                    echo "=== Partition maintenance completed successfully ==="
                    exit 0
                  else
                    echo "=== Partition maintenance failed ==="
                    echo "Create exit code: $CREATE_EXIT"
                    echo "Drop exit code: $DROP_EXIT"
                    exit 1
                  fi
              volumeMounts:
              - name: db-secret
                mountPath: /secrets/db
                readOnly: true
              resources:
                {{- toYaml .Values.partitionMaintenance.resources | nindent 16 }}
          volumes:
          - name: db-secret
            secret:
              secretName: {{ .Values.api.databaseSecretName | default (printf "%s-db-app" (include "ollyscale.fullname" .)) }}
{{- end }}
