apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
data:
  otel-collector-config.yaml: |
    # Default TinyOlly OTel Collector Config
    # This is the default configuration template used when no agents are connected.
    # It includes OTLP receivers, OpAMP extension, batch processing, spanmetrics connector,
    # and exports to both debug and OTLP endpoints.

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      
      # Prometheus Remote Write receiver
      # Receives metrics via Prometheus Remote Write protocol
      # Clients should send to: http://<collector-host>:19291/api/v1/write
      prometheusremotewrite:
        endpoint: "0.0.0.0:19291"

    extensions:
      opamp:
        server:
          ws:
            endpoint: ws://tinyolly-opamp-server:4320/v1/opamp

    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024

    connectors:
      spanmetrics:
        histogram:
          explicit:
            buckets: [1ms, 4ms, 10ms, 20ms, 50ms, 100ms, 200ms, 500ms, 1s, 2s, 5s]
        dimensions:
          - name: http.method
          - name: http.status_code
        dimensions_cache_size: 1000
        aggregation_temporality: "AGGREGATION_TEMPORALITY_CUMULATIVE"
        metrics_flush_interval: 15s
        metrics_expiration: 5m

    exporters:
      debug:
        verbosity: detailed
      
      otlp:
        endpoint: "tinyolly-otlp-receiver:4343"
        tls:
          insecure: true

    service:
      extensions: [opamp]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp, spanmetrics]
        
        metrics:
          receivers: [otlp, prometheusremotewrite, spanmetrics]
          processors: [batch]
          exporters: [debug, otlp]
        
        logs:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp]
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-supervisor-config
data:
  supervisor.yaml: |
    # OpAMP Supervisor Configuration for TinyOlly
    # This supervisor manages the OpenTelemetry Collector and accepts remote configuration
    # from the TinyOlly OpAMP server.

    server:
      endpoint: ws://tinyolly-opamp-server:4320/v1/opamp

    capabilities:
      # Accept remote configuration from OpAMP server
      accepts_remote_config: true
      # Accept restart commands
      accepts_restart_command: true
      # Report the effective (running) configuration back to server
      reports_effective_config: true
      # Report health status
      reports_health: true

    storage:
      # Directory for supervisor to store cached data
      directory: /var/lib/otelcol/supervisor

    agent:
      # Path to the collector binary
      executable: /opt/otelcol/bin/otelcol-contrib

      # How often to check if the collector process is still running
      orphan_detection_interval: 5s

      # Timeout for collector startup
      bootstrap_timeout: 10s

      # Configuration files to use
      # When $REMOTE_CONFIG is provided via OpAMP, it completely replaces the base config
      # (the supervisor handles this as a full replacement, not a merge)
      # The base config is only used until a remote config is first received
      config_files:
        - /etc/otelcol/config.yaml
        - $REMOTE_CONFIG

      # Allow the collector to start without any pipelines initially
      # (useful when waiting for remote config)
      args:
        - "--feature-gates"
        - "service.AllowNoPipelines"
